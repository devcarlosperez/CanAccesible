<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      type="image/png"
      href="/images/canaccesible_fav_icon.png"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title><%= title %></title>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
    <%- include('../../../partials/header') %>

    <div class="flex-1 max-w-4xl mx-auto w-full px-4 py-8">
      <!-- Breadcrumb -->
      <div class="mb-6 text-center">
        <a
          href="/dashboard-admin/conversations"
          class="text-neutral-500 hover:text-neutral-700 transition"
        >
          <i class="fa-solid fa-arrow-left mr-2"></i> Volver a Conversaciones
        </a>
      </div>

      <!-- Chat Container -->
      <div class="bg-white md:rounded-lg md:shadow-md p-4 md:p-6">
        <h2 class="text-2xl font-bold mb-4 text-center">
          Chat: <%= conversation.type.charAt(0).toUpperCase() +
          conversation.type.slice(1) %>
        </h2>

        <!-- Messages Area -->
        <div
          id="messagesContainer"
          class="md:h-96 h-[calc(100vh-200px)] overflow-y-auto border border-gray-300 rounded p-4 mb-4 bg-gray-50"
        >
          <div class="text-center text-gray-500 mt-4">Cargando mensajes...</div>
        </div>

        <!-- Input Area -->
        <div class="flex">
          <input
            type="text"
            id="messageInput"
            placeholder="Escribe tu mensaje..."
            class="flex-1 min-w-0 border border-gray-300 rounded-l px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
            onkeypress="handleKeyPress(event)"
          />
          <button
            onclick="sendMessage()"
            class="bg-blue-600 text-white px-4 py-2 rounded-r hover:bg-blue-700 transition flex items-center justify-center shrink-0"
          >
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>

    <script>
      const conversationId = <%= conversation.id %>;
      const jwtToken = '<%= jwtToken %>';
      const currentUserId = <%= currentUserId %>;
      let socket;
      let messages = [];
      let editingMessageId = null;
      let activeMenuId = null;

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        initSocket();
        fetchMessages();

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.message-menu-btn') && !e.target.closest('.message-menu')) {
                closeAllMenus();
            }
        });
      });

      function toggleMenu(e, msgId) {
          e.stopPropagation();
          const menu = document.getElementById(`menu-${msgId}`);
          const isHidden = menu.classList.contains('hidden');

          closeAllMenus();

          if (isHidden) {
              menu.classList.remove('hidden');
              activeMenuId = msgId;
          }
      }

      function closeAllMenus() {
          document.querySelectorAll('.message-menu').forEach(menu => menu.classList.add('hidden'));
          activeMenuId = null;
      }

      function initSocket() {
        // Connect to the same origin (backend)
        socket = io({
          query: { token: jwtToken }
        });

        socket.emit('joinConversation', conversationId);

        socket.on('newMessage', (msg) => {
          messages.push(msg);
          renderMessages();
          scrollToBottom();
        });
      }

      async function fetchMessages() {
        try {
          // Use relative path for API calls since dashboard is on the same server
          const response = await axios.get(`/api/conversationMessages/${conversationId}`, {
            headers: { Authorization: `Bearer ${jwtToken}` }
          });
          messages = response.data;
          renderMessages();
          scrollToBottom();
        } catch (error) {
          console.error('Error fetching messages:', error);
          document.getElementById('messagesContainer').innerHTML = '<div class="text-center text-red-500 mt-4">Error al cargar mensajes</div>';
        }
      }

      function renderMessages() {
        const container = document.getElementById('messagesContainer');

        if (messages.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center">No hay mensajes aún. ¡Inicia la conversación!</p>';
          return;
        }

        container.innerHTML = messages.map(msg => {
          const isOwn = msg.senderId === currentUserId;
          const isEditing = editingMessageId === msg.id;
          const date = new Date(msg.createdAt).toLocaleString('es-ES', {
            year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
          });

          return `
            <div class="mb-2 p-2 rounded max-w-[70%] relative group ${isOwn ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-200 text-black mr-auto'}">

              ${isEditing ? `
                <div class="flex flex-col">
                  <input
                    type="text"
                    id="editInput-${msg.id}"
                    value="${escapeHtml(msg.message)}"
                    class="text-black p-1 rounded mb-1 bg-white"
                  >
                  <div class="flex justify-end gap-2">
                    <button onclick="cancelEditing()" class="text-xs underline">Cancelar</button>
                    <button onclick="saveEdit(${msg.id})" class="text-xs underline">Guardar</button>
                  </div>
                </div>
              ` : `
                <p class="text-sm pr-6 whitespace-pre-wrap break-words">${escapeHtml(msg.message)}</p>
                <small class="text-xs ${isOwn ? 'text-blue-100' : 'text-gray-500'}">
                  ${date}
                </small>

                ${isOwn ? `
                  <button
                    onclick="toggleMenu(event, ${msg.id})"
                    class="message-menu-btn absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100"
                  >
                    <i class="fas fa-chevron-down text-xs"></i>
                  </button>

                  <div id="menu-${msg.id}" class="message-menu hidden absolute top-5 right-0 bg-white text-black shadow-lg rounded z-10 w-32 py-1">
                    <button
                      onclick="startEditing(${msg.id})"
                      class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100"
                    >
                      Editar
                    </button>
                    <button
                      onclick="deleteMessage(${msg.id})"
                      class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-red-600"
                    >
                      Eliminar
                    </button>
                  </div>
                ` : ''}
              `}
            </div>
          `;
        }).join('');
      }

      function startEditing(msgId) {
          editingMessageId = msgId;
          renderMessages();
      }

      function cancelEditing() {
          editingMessageId = null;
          renderMessages();
      }

      async function saveEdit(msgId) {
          const input = document.getElementById(`editInput-${msgId}`);
          const newText = input.value.trim();

          if (!newText) return;

          try {
              await axios.put(`/api/conversationMessages/${conversationId}/${msgId}`,
                  { message: newText },
                  { headers: { Authorization: `Bearer ${jwtToken}` } }
              );

              // Update local state
              messages = messages.map(m => m.id === msgId ? {...m, message: newText} : m);
              editingMessageId = null;
              renderMessages();
          } catch (error) {
              console.error('Error updating message:', error);
              alert('Error al actualizar mensaje');
          }
      }

      function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
      }

      async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text) return;

        if (socket) {
          socket.emit('sendMessage', {
            conversationId: conversationId,
            message: text,
            dateMessage: new Date()
          });
          input.value = '';
        }
      }

      async function deleteMessage(msgId) {
        if(!confirm('¿Eliminar mensaje?')) return;

        try {
          await axios.delete(`/api/conversationMessages/${conversationId}/${msgId}`, {
            headers: { Authorization: `Bearer ${jwtToken}` }
          });
          messages = messages.filter(m => m.id !== msgId);
          renderMessages();
        } catch (error) {
          console.error('Error deleting message:', error);
          alert('Error al eliminar mensaje');
        }
      }

      function handleKeyPress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
