<!-- Modal Backdrop -->
<div id="incidentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
  <!-- Modal Content -->
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[80vh] overflow-hidden">
    <!-- Header -->
    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-xl shrink-0">
      <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Nueva Incidencia</h3>
      <button onclick="closeIncidentModal()" class="text-gray-400 hover:text-gray-600 transition">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    <!-- Scrollable Form Container -->
    <div class="overflow-y-auto p-6 flex-grow">
      <form id="incidentForm" enctype="multipart/form-data">
        <input type="hidden" id="incidentId" name="id">

        <!-- Name Input -->
        <div class="mb-4">
          <label for="incidentName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
          <input type="text" id="incidentName" name="name" required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
            placeholder="Nombre de la incidencia">
        </div>

        <!-- Description Input -->
        <div class="mb-4">
          <label for="incidentDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
          <textarea id="incidentDescription" name="description" required rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition resize-none"
            placeholder="Descripción de la incidencia..."></textarea>
        </div>

        <!-- Status Input -->
        <div class="mb-4">
          <label for="incidentStatusId" class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
          <select name="incidentStatusId" id="incidentStatusId" class="w-full border rounded px-3 py-2" required>
            <option value="1">Pendiente</option>
            <option value="2">En Progreso</option>
            <option value="3">Resuelta</option>
          </select>
        </div>

        <!-- Type Input -->
        <div class="mb-4">
          <label for="incidentTypeId" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
          <select name="incidentTypeId" id="incidentTypeId" class="w-full border rounded px-3 py-2" required>
            <option value="1">Buena Práctica</option>
            <option value="2">Mala Práctica</option>
          </select>
        </div>

        <!-- Severity Input (hidden by default) -->
        <div class="mb-4" id="severityContainer" style="display:none;">
          <label for="incidentSeverityId" class="block text-sm font-medium text-gray-700 mb-1">Severidad</label>
          <select name="incidentSeverityId" id="incidentSeverityId" class="w-full border rounded px-3 py-2">
            <option value="1">Baja</option>
            <option value="2">Media</option>
            <option value="3">Alta</option>
          </select>
        </div>

        <!-- Area Input -->
        <div class="mb-4">
          <label for="incidentArea" class="block text-sm font-medium text-gray-700 mb-1">Área</label>
          <input type="text" name="area" id="incidentArea" class="w-full border rounded px-3 py-2" required>
        </div>

        <!-- Date Input -->
        <div class="mb-4">
          <label for="incidentDateIncident" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
          <input type="date" name="dateIncident" id="incidentDateIncident" class="w-full border rounded px-3 py-2" required>
        </div>

        <!-- Image Input -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">Imagen</label>
          <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-blue-500 transition cursor-pointer" onclick="document.getElementById('incidentImageFile').click()">
            <div class="space-y-1 text-center">
              <i class="fa-solid fa-cloud-arrow-up text-gray-400 text-3xl mb-2"></i>
              <div class="flex text-sm text-gray-600 justify-center">
                <label for="incidentImageFile" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                  <span>Sube un archivo</span>
                  <input id="incidentImageFile" name="imageFile" type="file" class="sr-only" accept="image/*">
                </label>
                <p class="pl-1">o arrastra y suelta</p>
              </div>
              <p class="text-xs text-gray-500">PNG, JPG, GIF hasta 10MB</p>
            </div>
          </div>
          <div id="imageFileName" class="mt-2 text-sm text-gray-600 hidden">
            Archivo seleccionado: <span id="selectedFileName"></span>
          </div>
          <img id="incidentImagePreview" src="" alt="Vista previa" class="mt-2 rounded max-h-40 hidden">
        </div>

        <!-- Mapa Leaflet y campos ocultos -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Selecciona la ubicación en el mapa</label>
          <div id="leafletMap" class="w-full h-64 rounded-lg border"></div>
          <input type="hidden" name="latitude" id="incidentLatitude">
          <input type="hidden" name="longitude" id="incidentLongitude">
          <input type="hidden" name="island" id="incidentIsland">
          <div id="islandError" class="text-red-600 text-sm mt-2 hidden">
            No se pudo detectar correctamente la isla. Selecciona un punto válido en el mapa.
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
          <button type="button" onclick="closeIncidentModal()" 
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition">
            Cancelar
          </button>
          <button type="submit" 
            class="px-6 py-2 bg-[#004aad] text-white rounded-lg hover:opacity-90 font-medium transition shadow-md">
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let leafletMap, leafletMarker;

  // Función para obtener la isla desde el código postal
  function getIslandFromPostalCode(postalCode) {
    const code = parseInt(postalCode, 10);
    if (code >= 35000 && code <= 35999) return "Gran Canaria";
    if (code >= 35500 && code <= 35599) return "Lanzarote";
    if (code >= 35600 && code <= 35699) return "Fuerteventura";
    if (code >= 38000 && code <= 38999) return "Tenerife";
    if (code >= 38700 && code <= 38799) return "La Palma";
    if (code >= 38800 && code <= 38899) return "La Gomera";
    if (code >= 38900 && code <= 38999) return "El Hierro";
    return "Desconocida";
  }

  async function reverseGeocode(lat, lng) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`);
      const data = await response.json();
      return data;
    } catch (err) {
      return null;
    }
  }

  function showIslandError(show) {
    document.getElementById('islandError').classList.toggle('hidden', !show);
  }

  function initLeafletMap(lat = 28.5, lng = -15.5) {
    if (leafletMap) leafletMap.remove();
    leafletMap = L.map('leafletMap').setView([lat, lng], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(leafletMap);

    leafletMarker = L.marker([lat, lng], { draggable: true }).addTo(leafletMap);

    document.getElementById('incidentLatitude').value = lat;
    document.getElementById('incidentLongitude').value = lng;

    async function updateMarkerPosition(position) {
      document.getElementById('incidentLatitude').value = position.lat;
      document.getElementById('incidentLongitude').value = position.lng;
      const geo = await reverseGeocode(position.lat, position.lng);
      let postalCode = geo?.address?.postcode;
      let island = postalCode ? getIslandFromPostalCode(postalCode) : "Desconocida";
      document.getElementById('incidentIsland').value = island;
      showIslandError(island === "Desconocida");
    }

    leafletMarker.on('dragend', async function(e) {
      const position = leafletMarker.getLatLng();
      await updateMarkerPosition(position);
    });

    leafletMap.on('click', async function(e) {
      leafletMarker.setLatLng(e.latlng);
      await updateMarkerPosition(e.latlng);
    });

    // Inicializa la isla
    updateMarkerPosition({ lat, lng });
  }

  // Abrir modal para crear
  function openCreateModal() {
    document.getElementById('incidentModal').classList.remove('hidden');
    document.getElementById('modalTitle').innerText = "Nueva Incidencia";
    document.getElementById('incidentForm').reset();
    document.getElementById('incidentId').value = "";
    document.getElementById('incidentImagePreview').src = "";
    document.getElementById('incidentImagePreview').classList.add('hidden');
    document.getElementById('severityContainer').style.display = "none";
    showIslandError(false);
    setTimeout(() => initLeafletMap(), 200);
  }

  // Abrir modal para editar
  function openEditModalFromData(id) {
    axios.get(`/api/incidents/${id}`)
      .then(response => {
        const incident = response.data;
        document.getElementById('incidentModal').classList.remove('hidden');
        document.getElementById('modalTitle').innerText = "Editar Incidencia";
        document.getElementById('incidentId').value = incident.id || "";
        document.getElementById('incidentName').value = incident.name || "";
        document.getElementById('incidentDescription').value = incident.description || "";
        document.getElementById('incidentStatusId').value = incident.incidentStatusId || 1;
        document.getElementById('incidentTypeId').value = incident.incidentTypeId || 1;
        document.getElementById('incidentSeverityId').value = incident.incidentSeverityId || 1;
        document.getElementById('incidentArea').value = incident.area || "";
        document.getElementById('incidentDateIncident').value = incident.dateIncident ? incident.dateIncident.split("T")[0] : "";
        if (incident.incidentTypeId == 2) {
          document.getElementById('severityContainer').style.display = "block";
        } else {
          document.getElementById('severityContainer').style.display = "none";
        }
        if (incident.nameFile) {
          document.getElementById('incidentImagePreview').src = incident.nameFile;
          document.getElementById('incidentImagePreview').classList.remove('hidden');
        } else {
          document.getElementById('incidentImagePreview').src = "";
          document.getElementById('incidentImagePreview').classList.add('hidden');
        }
        showIslandError(false);
        setTimeout(() => {
          initLeafletMap(
            incident.latitude || 28.5,
            incident.longitude || -15.5
          );
        }, 200);
      })
      .catch(error => {
        alert('Error cargando la incidencia');
      });
  }

  // Validación antes de enviar el formulario
  document.getElementById('incidentForm').addEventListener('submit', function(e) {
    const island = document.getElementById('incidentIsland').value;
    if (!island || island === "Desconocida") {
      showIslandError(true);
      e.preventDefault();
      return false;
    }
    showIslandError(false);
  });
</script>
