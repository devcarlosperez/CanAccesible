# OpenLDAP Setup

This document details the technical implementation of the OpenLDAP server for centralized user management, authentication, and groups in **CanAccesible** project.

---

## LDAP Concepts

### LDAP (Lightweight Directory Access Protocol)

It is an open, standard protocol for accessing and maintaining distributed directory information services over an IP network. In CanAccesible, it acts as the single source of truth for user authentication and centralizing user management.

### Distinguished Name (DN)

A DN is a unique identifier for each entry in the LDAP directory, similar to a full path in a file system. It consists of a sequence of Relative Distinguished Names (RDNs) separated by commas, read from right to left. For example: `uid=carlos,ou=users,dc=canaccesible,dc=es`.

In CanAccesible, DNs are used to uniquely identify users and perform authentication operations.

### Organizational Units (OU)

OUs are containers used to organize directory entries logically. They help structure the directory tree, similar to folders in a file system. In CanAccesible, we use OUs like `ou=users`, `ou=admins`, `ou=towns`, and `ou=groups` to categorize different types of entries.

### LDAP Filters

Filters are expressions used to search for entries in the directory. They use a specific syntax with operators like `=`, `&` (AND), `|` (OR), and `!` (NOT). For example:
- `(uid=carlos)`: Find entries where uid equals "carlos"
- `(|(uid=carlos)(mail=user@example.com))`: Find entries where uid is "carlos" OR mail is "user@example.com"

In CanAccesible, filters are used in search operations to locate users by email or UID.

### LDIF (LDAP Data Interchange Format)

LDIF is a standard text format for representing LDAP directory entries and changes. It is used to import and export data from LDAP directories. In CanAccesible, we use LDIF files to bootstrap initial data into the LDAP directory.

### Forward vs Reverse Lookup

**Forward Lookup**: This is the standard process where we search for an entry (like a user) based on their known attributes. For example, searching for the entry where `uid=carlos` to obtain their DN or email. In CanAccesible, this is used during login to find user details by email or username.

**Reverse Lookup**: Involves searching for context (e.g., groups) based on user identity, such as finding the groups a user belongs to by their UID. In CanAccesible, this method is defined but currently not used in the authentication flow; user roles are retrieved from the MySQL database instead.

### Authentication (Bind)

The credential validation process in LDAP is called "Bind". In CanAccesible, the backend first performs a Forward Lookup to retrieve the user's DN based on their email, then sends the DN and password to the LDAP server for verification. This is the core authentication mechanism used during login.

```javascript
async authenticateByEmail(searchValue, password) {
  const user = await this.forwardLookup(searchValue);
  if (!user) {
    return { success: false, message: 'User not found' };
  }
  return await this.authenticate(user.dn, password);
}
```

```javascript
async authenticate(userDN, password) {
  // ... connection setup ...
  console.log(`[LDAP] Authenticating: ${userDN}`);
  client = await this.createConnection();
  await this.bind(client, userDN, password);  // This is the bind operation
  console.log('[LDAP] Authentication successful');
  
  return {
    success: true,
    message: 'Authentication successful',
    userDN,
  };
}
```

```javascript
const ldapResult = await userService.authenticate(email, password);
if (!ldapResult) {
  return res.status(401).json({ message: 'Invalid credentials' });
// Proceed with successful authentication
```

---

## Docker Concepts

### Docker and Containers

Docker is a platform for developing, shipping, and running applications inside lightweight, portable containers. A container is a runnable instance of an image, which packages the application and its dependencies.

In CanAccesible, we use a Docker container for OpenLDAP to ensure consistent deployment across environments.

### Docker Compose

Docker Compose is a tool for defining and running multi-container Docker applications. It uses a YAML file (`docker-compose.yml`) to configure the services, networks, and volumes.

Our setup uses Docker Compose to orchestrate the OpenLDAP container with its configuration.

### Volumes

Volumes are the preferred mechanism for persisting data generated by and used by Docker containers. In our LDAP setup, we use named volumes (`ldap_data` and `ldap_config`) to persist the database and configuration files.

### Networks

Docker networks enable communication between containers. We use a custom network (`canaccesible-network`) to isolate the LDAP service.

---

## Installation and Deployment with Docker

To deploy OpenLDAP using Docker, follow these steps:

1. **Ensure Docker and Docker Compose are installed** on your system. If not, install them from the official Docker website.

2. **Navigate to the project root directory** where the `docker-compose.yml` file is located.

3. **Review the `docker-compose.yml` file** to understand the configuration:

   ```yaml
   services:
     openldap:
       image: osixia/openldap:latest
       container_name: openldap
       restart: unless-stopped
       environment:
         LDAP_ORGANISATION: "CanAccesible"
         LDAP_DOMAIN: "canaccesible.es"
         LDAP_ADMIN_PASSWORD: "admin"
       ports:
         - "389:389"
         - "636:636"
       volumes:
         - ./ldap/data.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/data.ldif
         - ldap_data:/var/lib/ldap
         - ldap_config:/etc/ldap/slapd.d
       command: --copy-service
       networks:
         - canaccesible-network
   ```

   **Explanation of the configuration:**
   - **Image**: Uses `osixia/openldap:latest`, a robust and popular LDAP server image.
   - **Environment**: Sets the organization (`CanAccesible`), domain (`canaccesible.es`), and admin password (`admin`).
   - **Ports**: Exposes LDAP on port 389 and LDAPS on port 636.
   - **Volumes**: 
     - `./ldap/data.ldif`: Mounts the initial directory data for bootstrap.
     - `ldap_data` and `ldap_config`: Named volumes for persistent storage of database and config.
   - **Command**: `--copy-service` ensures the bootstrap data is loaded.
   - **Networks**: Uses `canaccesible-network` for isolation.

4. **Start the OpenLDAP container** in detached mode:
   ```bash
   docker-compose up -d
   ```
   This command pulls the image if needed, creates the container, and starts it in the background.

5. **Verify the container is running**:
   ```bash
   docker ps
   ```
   You should see output similar to this:

   ![Docker PS Output](/docs/images/docker-ps.png)

6. **Check the logs** if needed:
   ```bash
   docker-compose logs openldap
   ```
   This helps troubleshoot any startup issues.
   
   The OpenLDAP server is now running.

---

## Data Structure (LDAP)

The directory structure is defined in the `/ldap/data.ldif` file. This file uses the **LDIF** (LDAP Data Interchange Format) to describe directory entries.

### Organizational Units (OUs)

We have segmented the directory into logical Organizational Units to better organize resources:

```ldif
# Organizational Units
dn: ou=users,dc=canaccesible,dc=es
objectClass: organizationalUnit
ou: users

dn: ou=admins,dc=canaccesible,dc=es
objectClass: organizationalUnit
ou: admins

dn: ou=towns,dc=canaccesible,dc=es
objectClass: organizationalUnit
ou: towns

dn: ou=groups,dc=canaccesible,dc=es
objectClass: organizationalUnit
ou: groups
```

*   **ou=users**: Standard platform users.
*   **ou=admins**: System administrators.
*   **ou=towns**: Municipality representatives.
*   **ou=groups**: Security groups and roles.

### Groups and Roles

We define POSIX groups and roles in the application:

```ldif
dn: cn=usuario,ou=groups,dc=canaccesible,dc=es
objectClass: posixGroup
cn: usuario
gidNumber: 1001

dn: cn=admin,ou=groups,dc=canaccesible,dc=es
objectClass: posixGroup
cn: admin
gidNumber: 1002

dn: cn=municipio,ou=groups,dc=canaccesible,dc=es
objectClass: posixGroup
cn: municipio
gidNumber: 1003
```

---

## User Creation and Authentication Flow

This section demonstrates the complete user lifecycle: creation from the frontend (storing in database and LDAP with appropriate group), verification, login, and LDAP authentication.

### Creating a User

Users are created through the web interface. The backend API stores user data in MySQL and creates the LDAP entry with the corresponding group.

![User Registration Form](/docs/images/user-registration-ldap.png)

**Verify User Entry (Forward Lookup):**

```bash
docker exec openldap ldapsearch -x -H ldap://localhost -b "dc=canaccesible,dc=es" -D "cn=admin,dc=canaccesible,dc=es" -w admin "(uid=ldap@gmail.com)"
```

This command performs a **Forward Lookup** by searching for the user entry based on the known UID attribute. It returns the user's LDAP entry in LDIF format, showing attributes like `dn`, `objectClass`, `uid`, `cn`, `mail`, and `userPassword` (hashed). A successful response indicates the user was created in LDAP.

![User LDAP Entry](/docs/images/user-screenshot-ldap.png)

**Verify Group Membership (Reverse Lookup Logic):**

```bash
docker exec openldap ldapsearch -x -H ldap://localhost -b "ou=groups,dc=canaccesible,dc=es" -D "cn=admin,dc=canaccesible,dc=es" -w admin "(memberUid=ldap@gmail.com)"
```

To confirm the user was assigned the correct role (group), we search for groups containing the user's UID. This aligns with the **Reverse Lookup** concept (finding roles based on user identity).

![User Group Membership](/docs/images/group-screenshot-ldap.png)

### User Login and LDAP Authentication

When logging in, the frontend sends credentials to the backend, which first queries the database for user details, then performs LDAP forward lookup and bind for authentication.

![User Login Form](/docs/images/login-ldap.png)

**LDAP Authentication Process (Backend Code):**

```javascript
// In auth.controller.js - First query DB for user and role
const user = await User.findOne({
  where: { email },
  include: [{ model: db.role, as: "role" }],
});

// Then authenticate via LDAP
const ldapResult = await userService.authenticate(email, password);

// In user.service.js - authenticate method
async authenticate(email, password) {
  const ldapUser = await this.forwardLookup(email);
  if (!ldapUser) return null;
  return await this.authenticate(ldapUser.dn, password);
}
```

**Verify Successful Authentication:**

Check the backend console logs (where `npm run dev` is running) for a sequence like:
```
Executing (default): SELECT `User`.`id`, ... FROM `Users` AS `User` LEFT OUTER JOIN `Roles` AS `role` ON `User`.`roleId` = `role`.`id` WHERE `User`.`email` = 'ldap@gmail.com';
[LDAP] Connected to server
[LDAP] Bind successful: cn=admin,dc=canaccesible,dc=es
[LDAP] Forward lookup for: ldap@gmail.com
[LDAP] User found: uid=ldap@gmail.com,ou=users,dc=canaccesible,dc=es
[LDAP] Connection closed
[LDAP] Authenticating: uid=ldap@gmail.com,ou=users,dc=canaccesible,dc=es
[LDAP] Connected to server
[LDAP] Bind successful: uid=ldap@gmail.com,ou=users,dc=canaccesible,dc=es
[LDAP] Authentication successful
[LDAP] Connection closed
```

This shows the complete flow: DB query, LDAP lookup, and successful authentication.